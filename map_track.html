<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AHMAS - Live Map & Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- LEAFLET MAPS (Required for GPS Tracking) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6', 100: '#CCFFCC', 500: '#00B300', 
                            600: '#009900', 700: '#008000', 800: '#006600', 900: '#004C00',
                        },
                        'teal': { 600: '#008080' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Map Container */
        #map-container { height: 100%; width: 100%; z-index: 1; }
        .custom-div-icon { background: transparent; border: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col">
    
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE CONFIG ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        const firebaseConfig = MANUAL_FIREBASE_CONFIG;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons({ root: wrapperRef.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className, ...props } });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        // --- LIVE MAP COMPONENT ---
        const LiveMap = ({ activeDrivers }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});

            useEffect(() => {
                if (!mapRef.current) return;

                // Initialize Map (Center on Cebu City)
                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current).setView([10.3157, 123.8854], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);
                }

                const map = mapInstanceRef.current;

                // Create custom icon for drivers (Green Car Dot)
                const carIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:#008000;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 0 8px rgba(0,0,0,0.5); position:relative;">
                            <div style="position:absolute; top:-25px; left:-50px; width:116px; text-align:center; font-weight:bold; font-size:10px; color:#006600; text-shadow:0 0 2px white;">Driver</div>
                           </div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                // Update Markers
                activeDrivers.forEach(driver => {
                    if (driver.location && driver.location.lat && driver.location.lng) {
                        const { lat, lng } = driver.location;
                        
                        // Check if data is old (> 5 mins)
                        const lastUpdate = driver.lastUpdated?.seconds ? driver.lastUpdated.seconds * 1000 : Date.now();
                        const isStale = (Date.now() - lastUpdate) > 300000; 

                        const popupContent = `
                            <div style="text-align:center; min-width: 100px;">
                                <h3 style="font-weight:bold; color:#333; margin:0;">${driver.name}</h3>
                                <div style="font-size:10px; color:${isStale?'red':'green'}; margin-top:4px;">
                                    ${isStale ? '‚ö†Ô∏è Signal Lost' : 'üü¢ Signal Active'}
                                </div>
                                <div style="font-size:9px; color:#999;">
                                    Speed: ${Math.round(driver.speed || 0)} m/s
                                </div>
                            </div>
                        `;

                        if (markersRef.current[driver.id]) {
                            // Move existing marker smoothly
                            markersRef.current[driver.id].setLatLng([lat, lng]);
                            markersRef.current[driver.id].setPopupContent(popupContent);
                        } else {
                            // Create new marker
                            const marker = L.marker([lat, lng], { icon: carIcon }).addTo(map);
                            marker.bindPopup(popupContent);
                            markersRef.current[driver.id] = marker;
                        }
                    }
                });

                // Cleanup removed drivers
                Object.keys(markersRef.current).forEach(id => {
                    if (!activeDrivers.find(d => d.id === id)) {
                        map.removeLayer(markersRef.current[id]);
                        delete markersRef.current[id];
                    }
                });

            }, [activeDrivers]);

            return <div id="map-container" ref={mapRef}></div>;
        };

        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [activeDrivers, setActiveDrivers] = useState([]);
            const [user, setUser] = useState(null);

            // Initialize Firebase
            useEffect(() => {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                auth.signInAnonymously().then(() => {
                    setFb({ db, auth });
                });

                // Check for existing login from the main app
                const savedUser = localStorage.getItem('spa_user');
                if(savedUser) setUser(JSON.parse(savedUser));
            }, []);

            // Listen for Driver Locations
            useEffect(() => {
                if (!fb) return;
                
                // Only listen for 'active' drivers to save data
                const unsub = fb.db.collection('drivers')
                    .where('status', '==', 'active')
                    .onSnapshot(snapshot => {
                        const drivers = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setActiveDrivers(drivers);
                    });

                return () => unsub();
            }, [fb]);

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <header className="bg-white border-b p-3 flex justify-between items-center shadow-md z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-logo-green-700 text-white p-2 rounded-lg">
                                <Icon name="map" size={20} />
                            </div>
                            <div>
                                <h1 className="font-bold text-slate-800 leading-none">AHMAS Live Map</h1>
                                <p className="text-xs text-slate-500">Real-time Fleet Tracking</p>
                            </div>
                        </div>
                        
                        <div className="flex gap-2">
                            <div className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 border border-green-200">
                                <div className="w-2 h-2 bg-green-600 rounded-full animate-pulse"></div>
                                {activeDrivers.length} Online
                            </div>
                            <a href="index.html" className="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold border hover:bg-slate-200 flex items-center gap-1">
                                <Icon name="layout-dashboard" size={14}/> Dashboard
                            </a>
                        </div>
                    </header>

                    {/* Map Area */}
                    <main className="flex-1 relative">
                        <LiveMap activeDrivers={activeDrivers} />
                        
                        {/* Floating Driver List Overlay */}
                        <div className="absolute top-4 right-4 z-[500] w-64 bg-white/90 backdrop-blur rounded-xl shadow-xl border border-slate-200 max-h-[50%] overflow-y-auto hidden sm:block">
                            <div className="p-3 border-b border-slate-100 bg-slate-50 rounded-t-xl">
                                <h3 className="text-xs font-bold text-slate-500 uppercase">Active Drivers</h3>
                            </div>
                            <div className="p-2 space-y-1">
                                {activeDrivers.length === 0 ? (
                                    <p className="text-xs text-slate-400 text-center py-4 italic">No drivers currently active.</p>
                                ) : (
                                    activeDrivers.map(d => (
                                        <div key={d.id} className="flex items-center justify-between p-2 hover:bg-green-50 rounded-lg transition cursor-pointer">
                                            <div className="flex items-center gap-2">
                                                <div className="w-8 h-8 bg-green-100 text-green-700 rounded-full flex items-center justify-center font-bold text-xs">
                                                    {d.name.charAt(0)}
                                                </div>
                                                <div>
                                                    <p className="text-sm font-bold text-slate-700 leading-none">{d.name}</p>
                                                    <p className="text-[10px] text-slate-400">{d.speed ? Math.round(d.speed) + ' m/s' : 'Stopped'}</p>
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" size={14} className="text-slate-300"/>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
