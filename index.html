<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Custom Tailwind Configuration to use the Logo's Primary Green (#008000)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6',
                            100: '#CCFFCC',
                            500: '#00B300',
                            600: '#009900',
                            700: '#008000',
                            800: '#006600',
                            900: '#004C00',
                        },
                        'teal': {
                            600: '#008080',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #008000;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .loader-lg {
            width: 48px;
            height: 48px;
            border-width: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dispatch map container full-screen transition */
        .dispatch-container { height: calc(100vh - 80px); min-height: 480px; border-radius: 12px; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIG: Replace with your Google Maps JS API key ---
        const GMAPS_API_KEY = AIzaSyCqz4TUTF6gIs5uG990RuywpePga3CtIQc; //

        // --- CONSTANTS (from your original file) ---
        const BRANCHES = [
            'Guadalupe',
            'Mabolo',
            'Talisay',
            'Bacayan',
            'Lapu-lapu',
            'AS Fortuna'
        ];
        const SERVICE_CATEGORIES = [
            'Specialized Massage',
            'Relax & Revive',
            'Premium Massage',
            'Add-ons',
            'Others'
        ];

        // --- FIREBASE CONFIG (kept from your original) ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKfftJL6ZkFCdxVT5wyWWPqtvPd2eRLJk",
            authDomain: "ahmas-system.firebaseapp.com",
            databaseURL: "https://ahmas-system-default-rtdb.firebaseio.com",
            projectId: "ahmas-system",
            storageBucket: "ahmas-system.firebasestorage.app",
            messagingSenderId: "3535933918",
            appId: "1:3535933918:web:24eb6311bd0c49750b0d4f",
            measurementId: "G-D8SXDWE6SW"
        };
        const firebaseConfig = MANUAL_FIREBASE_CONFIG;
        const currentAppId = firebaseConfig.projectId;

        // --- Icon helper (keeps lucide usage) ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons({
                        root: wrapperRef.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, class: className, ...props }
                    });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };
        const Icons = {
            Users: (p) => <Icon name="users" {...p} />,
            Car: (p) => <Icon name="car" {...p} />,
            Map: (p) => <Icon name="map" {...p} />,
            Phone: (p) => <Icon name="phone" {...p} />,
            MessageCircle: (p) => <Icon name="message-circle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />
        };

        // --- HASH HELPER (kept) ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            try {
                const msgUint8 = new TextEncoder().encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            } catch (error) {
                console.error("Hashing failed:", error);
                return null;
            }
        };

        // --- Loading overlay component ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );

        // --- DispatchMap Component ---
        function DispatchMap({ fb, onClose }) {
            const mapRef = useRef(null);
            const mapDivRef = useRef(null);
            const markersRef = useRef({});
            const infoWindowRef = useRef(null);
            const [isMapReady, setIsMapReady] = useState(false);
            const [drivers, setDrivers] = useState([]);
            const collectionPath = `artifacts/${currentAppId}/public/data/driver_locations`;

            // Load Google Maps script dynamically if not present
            useEffect(() => {
                if (!GMAPS_API_KEY || GMAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY_HERE") {
                    console.warn("Google Maps API key placeholder detected. Replace GMAPS_API_KEY with real API key for maps to load.");
                    // still create a blank area to avoid crash
                    setIsMapReady(false);
                    return;
                }

                // If google maps loaded, initialize
                if (window.google && window.google.maps) {
                    setIsMapReady(true);
                    return;
                }

                // Add script
                const existing = document.querySelector(`script[data-gmaps="1"]`);
                if (existing) {
                    existing.addEventListener('load', () => setIsMapReady(true));
                    return;
                }

                const s = document.createElement('script');
                s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_API_KEY}&libraries=places`;
                s.async = true;
                s.defer = true;
                s.setAttribute('data-gmaps', '1');
                s.onload = () => setIsMapReady(true);
                s.onerror = (e) => {
                    console.error("Failed to load Google Maps script", e);
                    setIsMapReady(false);
                };
                document.head.appendChild(s);
            }, []);

            // Initialize map when script ready and container exists
            useEffect(() => {
                if (!isMapReady || !mapDivRef.current) return;
                if (mapRef.current) return; // already created

                const center = { lat: 10.3157, lng: 123.8854 }; // Cebu center default

                mapRef.current = new google.maps.Map(mapDivRef.current, {
                    center,
                    zoom: 12,
                    gestureHandling: 'greedy',
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true
                });

                infoWindowRef.current = new google.maps.InfoWindow();
            }, [isMapReady]);

            // Firestore realtime subscription
            useEffect(() => {
                if (!fb || !fb.db) return;
                const coll = fb.db.collection(collectionPath);

                const unsubscribe = coll.onSnapshot(snapshot => {
                    const docs = snapshot.docs.map(d => ({ id: d.id, ...(d.data ? d.data() : {}), raw: d }));
                    setDrivers(docs);
                }, (err) => console.error("DispatchMap listener error:", err));

                return () => unsubscribe();
            }, [fb]);

            // Update markers when drivers changes
            useEffect(() => {
                if (!mapRef.current) return;

                const map = mapRef.current;
                const markers = markersRef.current;

                // Helper to create/update marker
                const upsertMarker = (driver) => {
                    if (!driver || driver.latitude == null || driver.longitude == null) return;
                    const id = driver.id || driver.driverId || Math.random().toString(36).slice(2,9);
                    const pos = { lat: parseFloat(driver.latitude), lng: parseFloat(driver.longitude) };

                    // Choose marker color based on driver.currentDriverStatus or isTrackingActive
                    let color = '#888888';
                    const status = (driver.currentDriverStatus || '').toString().toLowerCase();
                    if ((driver.isTrackingActive === true) || status.includes('driv') || status.includes('en route') || status.includes('en_route') || status.includes('driving')) color = '#1E90FF'; // blue
                    if (status.includes('arrived') || status.includes('arrive')) color = '#00B300'; // green
                    if (status.includes('completed') || status.includes('done')) color = '#6B7280'; // gray
                    if (status.includes('declin') || status.includes('declined')) color = '#FF7043'; // orange/red

                    const icon = {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: color,
                        fillOpacity: 1,
                        strokeWeight: 1,
                        strokeColor: '#ffffff'
                    };

                    if (markers[id]) {
                        // animate marker transition — setPosition
                        markers[id].setPosition(pos);
                        markers[id].setIcon(icon);
                        markers[id].driver = driver;
                    } else {
                        const m = new google.maps.Marker({
                            position: pos,
                            map,
                            title: driver.driverName || driver.driverId || driver.id || 'Driver',
                            icon
                        });
                        m.driver = driver;
                        m.addListener('click', () => {
                            const d = m.driver || {};
                            const content = buildInfoWindowHTML(d);
                            infoWindowRef.current.setContent(content);
                            infoWindowRef.current.open(map, m);
                            // Attach event listeners after DOM insertion (call/message buttons)
                            setTimeout(bindInfoWindowButtons, 50);
                        });
                        markers[id] = m;
                    }
                };

                const buildInfoWindowHTML = (d) => {
                    const lastPing = d.lastPing && d.lastPing.toDate ? d.lastPing.toDate().toLocaleString() : (d.lastPing ? new Date(d.lastPing).toLocaleString() : 'N/A');
                    const phone = d.contactNumber || d.contact || d.phone || 'N/A';
                    const status = d.currentDriverStatus || (d.isTrackingActive ? 'Online' : 'Offline');
                    const job = d.currentBookingId || d.currentJobId || '—';
                    const branch = d.currentBranch || d.branch || '—';
                    const name = d.driverName || d.name || d.id || 'Driver';

                    // Use sms: and tel:
                    return `
                        <div style="min-width:220px; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;">
                          <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:700; font-size:14px; color:#0f172a;">${escapeHtml(name)}</div>
                          </div>
                          <div style="font-size:12px; color:#475569; margin-top:6px;">
                             <div><strong>Status:</strong> ${escapeHtml(String(status))}</div>
                             <div><strong>Branch:</strong> ${escapeHtml(branch)}</div>
                             <div><strong>Job:</strong> ${escapeHtml(job)}</div>
                             <div><strong>Last ping:</strong> ${escapeHtml(lastPing)}</div>
                             <div style="margin-top:8px; display:flex; gap:6px;">
                               <button id="__call_btn" data-phone="${escapeHtml(phone)}" style="flex:1; padding:8px; border-radius:8px; background:#00B300; color:white; border:none; font-weight:600; cursor:pointer;">
                                 <span style="display:inline-flex; align-items:center; gap:6px;">Call</span>
                               </button>
                               <button id="__sms_btn" data-phone="${escapeHtml(phone)}" style="flex:1; padding:8px; border-radius:8px; background:#3B82F6; color:white; border:none; font-weight:600; cursor:pointer;">
                                 <span style="display:inline-flex; align-items:center; gap:6px;">Message</span>
                               </button>
                             </div>
                             <div style="margin-top:8px; display:flex; gap:6px;">
                               <button id="__nav_btn" data-dest="${escapeHtml(d.assignedClientAddress || d.clientAddress || '')}" style="flex:1; padding:8px; border-radius:8px; background:#111827; color:white; border:none; font-weight:600; cursor:pointer;">
                                 Navigate
                               </button>
                               <button id="__center_btn" style="padding:8px; border-radius:8px; background:#6B7280; color:white; border:none; font-weight:600; cursor:pointer;">
                                 Center
                               </button>
                             </div>
                          </div>
                        </div>
                    `;
                };

                const bindInfoWindowButtons = () => {
                    const callBtn = document.getElementById('__call_btn');
                    const smsBtn = document.getElementById('__sms_btn');
                    const navBtn = document.getElementById('__nav_btn');
                    const centerBtn = document.getElementById('__center_btn');

                    if (callBtn) {
                        callBtn.onclick = (e) => {
                            const phone = e.currentTarget.dataset.phone;
                            if (phone && phone !== 'N/A') window.open(`tel:${phone}`);
                        };
                    }
                    if (smsBtn) {
                        smsBtn.onclick = (e) => {
                            const phone = e.currentTarget.dataset.phone;
                            if (phone && phone !== 'N/A') {
                                // sms: scheme; some browsers/platforms may prefer sms:
                                window.open(`sms:${phone}`);
                            }
                        };
                    }
                    if (navBtn) {
                        navBtn.onclick = (e) => {
                            const dest = e.currentTarget.dataset.dest || '';
                            if (dest && dest.length > 0) {
                                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`);
                            } else {
                                alert('No destination address available.');
                            }
                        };
                    }
                    if (centerBtn) {
                        centerBtn.onclick = () => infoWindowRef.current && mapRef.current && mapRef.current.panTo(infoWindowRef.current.getPosition ? infoWindowRef.current.getPosition() : mapRef.current.getCenter());
                    }
                };

                const escapeHtml = (str) => {
                    if (!str) return '';
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                };

                // Remove markers not in drivers
                const existingIds = new Set(drivers.map(d => d.id || d.driverId));
                Object.keys(markers).forEach(id => {
                    if (!existingIds.has(id)) {
                        markers[id].setMap(null);
                        delete markers[id];
                    }
                });

                // Upsert markers
                drivers.forEach(d => {
                    upsertMarker(d);
                });

                // Optionally auto-fit bounds based on visible markers
                const markerList = Object.values(markers);
                if (markerList.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    markerList.forEach(m => bounds.extend(m.getPosition()));
                    try { map.fitBounds(bounds, 80); } catch (e) { /* ignore */ }
                }

                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [drivers, isMapReady]);

            return (
                <div className="p-4">
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-logo-green-800 flex items-center gap-2"><Icons.Map size={20}/> Dispatch Map</h2>
                            <p className="text-sm text-slate-500">Live driver locations — updates in realtime via Firestore.</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={onClose} className="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded flex items-center gap-2">
                                <Icons.X size={16}/> Close
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 gap-4">
                        <div className="col-span-1 bg-white rounded-xl p-3 shadow-sm overflow-y-auto max-h-[70vh]">
                            <h3 className="font-semibold text-sm text-slate-700 mb-2">Drivers ({drivers.length})</h3>
                            <div className="space-y-2">
                                {drivers.map(d => {
                                    const status = d.currentDriverStatus || (d.isTrackingActive ? 'Online' : 'Offline');
                                    const lat = d.latitude ? Number(d.latitude).toFixed(5) : '—';
                                    const lng = d.longitude ? Number(d.longitude).toFixed(5) : '—';
                                    return (
                                        <div key={d.id} className="p-2 border rounded flex items-center justify-between gap-2 hover:bg-slate-50">
                                            <div>
                                                <div className="font-bold text-sm">{d.driverName || d.name || d.id}</div>
                                                <div className="text-xs text-slate-500">{d.currentBranch || d.branch || '—'} • {status}</div>
                                                <div className="text-xs text-slate-400">Lat: {lat} · Lng: {lng}</div>
                                            </div>
                                            <div className="flex flex-col gap-2">
                                                <button onClick={() => {
                                                    // center marker
                                                    const m = markersRef.current[d.id];
                                                    if (m && mapRef.current) {
                                                        mapRef.current.panTo(m.getPosition());
                                                        mapRef.current.setZoom(15);
                                                        google.maps.event.trigger(m, 'click');
                                                    } else {
                                                        alert('Location not available or marker not created yet.');
                                                    }
                                                }} className="px-2 py-1 bg-logo-green-600 text-white rounded text-xs">Center</button>

                                                <button onClick={() => {
                                                    const ph = d.contactNumber || d.contact || d.phone;
                                                    if (ph) window.open(`tel:${ph}`);
                                                    else alert('No contact number available.');
                                                }} className="px-2 py-1 bg-slate-100 rounded text-xs">Call</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="col-span-3">
                            <div className="bg-white rounded-xl shadow-sm border dispatch-container">
                                { !GMAPS_API_KEY || GMAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY_HERE" ? (
                                    <div className="flex items-center justify-center h-full">
                                        <div className="text-center p-6">
                                            <div className="text-lg font-bold mb-2 text-slate-700">Google Maps API key missing</div>
                                            <div className="text-sm text-slate-500 mb-4">Please replace <code>GMAPS_API_KEY</code> in the top of the file with your API key.</div>
                                            <div className="text-sm italic text-slate-400">Map will load when a valid key is provided.</div>
                                        </div>
                                    </div>
                                ) : (
                                    <div ref={mapDivRef} style={{width:'100%', height:'100%'}} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP (simplified to include Dispatch Map button) ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null);
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);

            const [view, setView] = useState('dashboard'); // default original dashboard
            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [driversList, setDriversList] = useState([]); // existing usage elsewhere

            // Initialize firebase
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        await auth.signInAnonymously();
                        auth.onAuthStateChanged((u) => {
                            if (u) {
                                setFbUser(u);
                                setFb({ db, auth, appId: currentAppId });
                            }
                        });
                    } catch (err) {
                        console.error("FB Init Error", err);
                        setConfigError(err.message || 'Firebase init failed');
                    }
                };
                initFirebase();

                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            // Small floating button to open Dispatch Map (non-invasive)
            return (
                <div className="min-h-screen">
                    {/* Top header (minimal) */}
                    <div className="bg-white shadow-sm py-3 px-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="text-logo-green-700 font-bold text-lg">At HOME Massage & Spa</div>
                            <div className="text-sm text-slate-500">Dispatch Console</div>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="text-xs text-slate-500 hidden md:block">Status: <span className={`ml-2 ${isOnline ? 'text-green-600' : 'text-red-500'}`}>{isOnline ? 'Online' : 'Offline'}</span></div>
                            <button onClick={() => setView('dashboard')} className="px-3 py-2 rounded hover:bg-slate-100">Dashboard</button>
                            <button onClick={() => setView('dispatch')} className="px-3 py-2 bg-logo-green-600 text-white rounded hover:bg-logo-green-700 flex items-center gap-2"><Icons.Map size={16}/> Dispatch</button>
                        </div>
                    </div>

                    {/* Main body */}
                    <div className="p-4">
                        { view === 'dashboard' && (
                            <div className="bg-white rounded-xl p-6 shadow-sm">
                                <h3 className="font-bold text-lg text-slate-700">Dashboard</h3>
                                <p className="text-slate-500 mt-2">This is your existing dashboard. Click the green <strong>Dispatch</strong> button to open the Dispatch Map.</p>
                            </div>
                        ) }

                        { view === 'dispatch' && (
                            <div className="mt-4">
                                <DispatchMap fb={fb} onClose={() => setView('dashboard')} />
                            </div>
                        ) }
                    </div>

                    {/* Floating quick access button (mobile-friendly) */}
                    <div className="fixed right-4 bottom-4 z-50">
                        <div className="bg-white p-2 rounded-full shadow-lg">
                            <button onClick={() => setView('dispatch')} title="Open Dispatch Map" className="w-12 h-12 rounded-full bg-logo-green-600 text-white flex items-center justify-center">
                                <Icons.Map size={20}/>
                            </button>
                        </div>
                    </div>

                    { isGlobalLoading && <LoadingOverlay message="Processing..." /> }
                    { configError && <div className="fixed left-4 bottom-4 p-3 bg-red-100 text-red-700 rounded shadow">{configError}</div> }
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
