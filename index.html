<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>At HOME Massage & Spa Tracker</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React UMD -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel for in-browser JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide icons (UMD) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Firebase compat libs (used by original app) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- LEAFLET for maps (added from map_track.html) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Tailwind custom config (keeps your custom colors)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6',
                            100: '#CCFFCC',
                            500: '#00B300',
                            600: '#009900',
                            700: '#008000',
                            800: '#006600',
                            900: '#004C00',
                        },
                        'teal': { 600: '#008080' }
                    }
                }
            }
        };
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* loaders from original */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #008000;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        .loader-lg { width:48px; height:48px; border-width:5px; }
        @keyframes spin { 0%{transform:rotate(0deg)}100%{transform:rotate(360deg)} }

        /* Map container */
        #map-container { height: 100%; width: 100%; z-index: 1; }
        .custom-div-icon { background: transparent; border: none; }

        /* Floating back button style */
        .map-back-btn {
            position: fixed;
            top: 14px;
            left: 14px;
            z-index: 1200;
            width: 44px;
            height: 44px;
            border-radius: 999px;
            background: white;
            box-shadow: 0 6px 18px rgba(2,6,23,0.12);
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <!-- Main app script (JSX via Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS (copied from index.html) ---
        const BRANCHES = ['Guadalupe','Mabolo','Talisay','Bacayan','Lapu-lapu','AS Fortuna'];
        const SERVICE_CATEGORIES = ['Specialized Massage','Relax & Revive','Premium Massage','Add-ons','Others'];

        // --- FIREBASE CONFIG (the same manual config present in both files) ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        const firebaseConfig = MANUAL_FIREBASE_CONFIG;
        const currentAppId = firebaseConfig.projectId;

        // --- Icon wrapper (uses lucide UMD) ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons({ root: wrapperRef.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className, ...props } });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        // --- Helper: getMillis (from index) ---
        const getMillis = (ts) => {
            if (!ts) return Date.now();
            if (typeof ts === 'number') return ts;
            if (typeof ts.toMillis === 'function') return ts.toMillis();
            if (ts.seconds) return ts.seconds * 1000;
            return 0;
        };

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth()+1).padStart(2,'0');
            const day = String(now.getDate()).padStart(2,'0');
            return `${year}-${month}-${day}`;
        };

        // --- LOADING OVERLAY COMPONENT (from index) ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );

        // ----------------------------------------
        // LIVE MAP COMPONENT (adapted from map_track.html)
        // ----------------------------------------
        const LiveMap = ({ activeDrivers }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});

            useEffect(() => {
                if (!mapRef.current) return;

                // Initialize the Leaflet map once
                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current, { preferCanvas: true }).setView([10.3157, 123.8854], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);
                }
                const map = mapInstanceRef.current;

                // Small helper to create driver icon
                const createCarIcon = (label) => {
                    return L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:#008000;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 0 8px rgba(0,0,0,0.5); position:relative;">
                                ${label ? `<div style="position:absolute; top:-24px; left:-40px; width:120px; text-align:center; font-weight:bold; font-size:10px; color:#006600; text-shadow:0 0 2px white;">${label}</div>` : ''}
                               </div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                };

                // Update markers when activeDrivers changes
                activeDrivers.forEach(driver => {
                    if (driver && driver.location && driver.location.lat && driver.location.lng) {
                        const lat = Number(driver.location.lat);
                        const lng = Number(driver.location.lng);
                        const id = driver.id || driver._id || driver.docId || driver.name;
                        const lastUpdate = driver.lastUpdated?.seconds ? driver.lastUpdated.seconds * 1000 : (driver.lastUpdated || Date.now());
                        const isStale = (Date.now() - lastUpdate) > (5 * 60 * 1000); // 5 minutes

                        const popupContent = `<div style="text-align:center;min-width:120px">
                            <h3 style="margin:0;font-weight:700;color:#333">${driver.name || 'Driver'}</h3>
                            <div style="font-size:10px;color:${isStale ? 'red' : 'green'};margin-top:4px;">
                                ${isStale ? '‚ö†Ô∏è Signal Lost' : 'üü¢ Signal Active'}
                            </div>
                            <div style="font-size:9px;color:#666;margin-top:6px;">
                                Speed: ${Math.round(driver.speed || 0)} m/s
                            </div>
                        </div>`;

                        if (markersRef.current[id]) {
                            markersRef.current[id].setLatLng([lat, lng]);
                            markersRef.current[id].setPopupContent(popupContent);
                        } else {
                            const marker = L.marker([lat, lng], { icon: createCarIcon(driver.name) }).addTo(map);
                            marker.bindPopup(popupContent);
                            markersRef.current[id] = marker;
                        }
                    }
                });

                // Remove markers that are no longer in activeDrivers
                Object.keys(markersRef.current).forEach(id => {
                    if (!activeDrivers.find(d => (d.id === id || d.docId === id || d._id === id || d.name === id))) {
                        try {
                            map.removeLayer(markersRef.current[id]);
                        } catch (e) {}
                        delete markersRef.current[id];
                    }
                });

                // optional: fit bounds if many drivers
                // const markerPositions = Object.values(markersRef.current).map(m => m.getLatLng());
                // if (markerPositions.length > 0) map.fitBounds(markerPositions, { padding: [60, 60] });

            }, [activeDrivers]);

            return <div id="map-container" ref={mapRef} style={{height:'100%'}} />;
        };

        // A wrapper view to display the LiveMap fullscreen with header + active driver list + back button
        const LiveMapView = ({ fb, onBack }) => {
            const [activeDrivers, setActiveDrivers] = useState([]);
            const unsubRef = useRef(null);

            useEffect(() => {
                if (!fb || !fb.db) return;
                // Use same base path pattern as index app
                const basePath = `artifacts/${fb.appId}/public/data`;
                const driversColl = fb.db.collection(`${basePath}/drivers`);

                // Subscribe only to active drivers while in the view
                unsubRef.current = driversColl.where('status', '==', 'active').onSnapshot(snapshot => {
                    const drivers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setActiveDrivers(drivers);
                }, err => {
                    console.error("Drivers listener failed", err);
                });

                return () => {
                    if (typeof unsubRef.current === 'function') unsubRef.current();
                };
            }, [fb]);

            return (
                <div className="fixed inset-0 z-40 bg-slate-50">
                    {/* Back button top-left */}
                    <div className="map-back-btn" title="Back to dashboard" onClick={onBack}>
                        <Icon name="arrow-left" size={20}/>
                    </div>

                    {/* Header (small, overlay) */}
                    <header className="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-white/80 backdrop-blur rounded-full px-4 py-2 flex items-center gap-3 shadow-md border border-slate-100">
                        <div className="bg-logo-green-700 text-white p-2 rounded-full"><Icon name="map-pin" size={16}/></div>
                        <div>
                            <div className="text-sm font-bold text-slate-800">AHMAS Live Map</div>
                            <div className="text-xs text-slate-500">Real-time Fleet Tracking</div>
                        </div>
                        <div className="ml-4 bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-2 border border-green-200">
                            <div className="w-2 h-2 bg-green-600 rounded-full animate-pulse"></div>
                            {activeDrivers.length} Online
                        </div>
                    </header>

                    {/* Map area */}
                    <main className="absolute inset-0 z-10">
                        <LiveMap activeDrivers={activeDrivers} />
                    </main>

                    {/* Floating Active Drivers list (right) */}
                    <aside className="hidden sm:block absolute top-20 right-4 z-50 w-72 bg-white/90 backdrop-blur rounded-xl shadow-xl border border-slate-200 max-h-[60%] overflow-y-auto">
                        <div className="p-3 border-b border-slate-100 bg-slate-50 rounded-t-xl">
                            <h3 className="text-xs font-bold text-slate-500 uppercase">Active Drivers</h3>
                        </div>
                        <div className="p-2 space-y-1">
                            {activeDrivers.length === 0 ? (
                                <p className="text-xs text-slate-400 text-center py-4 italic">No drivers currently active.</p>
                            ) : (
                                activeDrivers.map(d => (
                                    <div key={d.id} className="flex items-center justify-between p-2 hover:bg-green-50 rounded-lg transition cursor-pointer">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 bg-green-100 text-green-700 rounded-full flex items-center justify-center font-bold text-xs">
                                                {d.name ? d.name.charAt(0) : 'D'}
                                            </div>
                                            <div>
                                                <p className="text-sm font-bold text-slate-700 leading-none">{d.name || 'Driver'}</p>
                                                <p className="text-[10px] text-slate-400">{d.speed ? Math.round(d.speed) + ' m/s' : 'Stopped'}</p>
                                            </div>
                                        </div>
                                        <Icon name="chevron-right" size={14} className="text-slate-300"/>
                                    </div>
                                ))
                            )}
                        </div>
                    </aside>
                </div>
            );
        };

        // ----------------------------------------
        // MAIN APP (index.html core)
        // ----------------------------------------
        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null);
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);

            // user/session state (copied/condensed)
            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [view, setView] = useState('dashboard');
            const [dashboardDate, setDashboardDate] = useState(getTodayStr());

            // Master lists (example)
            const [driversList, setDriversList] = useState([]);
            const [therapistsList, setTherapistsList] = useState([]);
            const [servicesList, setServicesList] = useState([]);
            const [durationsList, setDurationsList] = useState([]);
            const [roomsList, setRoomsList] = useState([]);

            // --- Initialize Firebase & restore session (similar to original) ---
            useEffect(() => {
                const init = async () => {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const db = firebase.firestore();

                        // sign in anonymously for Firestore reads if not already logged in
                        await auth.signInAnonymously();

                        auth.onAuthStateChanged(u => {
                            if (u) {
                                setFbUser(u);
                                setFb({ db, auth, appId: currentAppId });
                            }
                        });
                    } catch (err) {
                        console.error("FB Init error", err);
                        setConfigError(err?.message || String(err));
                    }
                };
                init();

                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            // --- Basic listener for master lists (drivers) so small admin pages still work ---
            useEffect(() => {
                if (!fb || !fb.db) return;
                const basePath = `artifacts/${fb.appId}/public/data`;

                // drivers list (used in some admin UI)
                const unsubDrivers = fb.db.collection(`${basePath}/drivers`)
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDriversList(data.sort((a,b)=> (a.name||'').localeCompare(b.name||'')));
                    }, err => console.error("Drivers list listener", err));

                // You can add other list listeners here if needed (therapists/services/durations)
                return () => {
                    try { unsubDrivers && unsubDrivers(); } catch(e){}
                };
            }, [fb]);

            // --- Sample Navigation UI (inject Live Map button in main nav) ---
            // NOTE: your real index has a rich layout; here's the core nav + content switch to include 'live_map'
            return (
                <div className="min-h-screen bg-slate-50">
                    {/* Top navigation / main buttons (keeps style consistent with original) */}
                    <div className="bg-white p-3 border-b shadow-sm sticky top-0 z-30">
                        <div className="max-w-6xl mx-auto flex items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-logo-green-700 text-white p-2 rounded-lg">
                                    <Icon name="home" size={18}/>
                                </div>
                                <div>
                                    <h1 className="font-bold text-slate-800">At HOME Massage & Spa Tracker</h1>
                                    <p className="text-xs text-slate-500">Staff Dashboard</p>
                                </div>
                            </div>

                            <div className="flex items-center gap-2">
                                {/* Main nav buttons (Dashboard, History, Map (NEW), Team, Lists, Profile) */}
                                <div className="flex gap-2 bg-slate-100 p-1 rounded-lg">
                                    <button onClick={() => setView('dashboard')} className={`px-3 py-2 rounded-md text-sm font-semibold ${view==='dashboard' ? 'bg-white text-logo-green-700 shadow' : 'text-slate-500'}`}>
                                        <Icon name="layout-dashboard" size={14}/> <span className="hidden sm:inline ml-1">Dashboard</span>
                                    </button>
                                    <button onClick={() => setView('history')} className={`px-3 py-2 rounded-md text-sm font-semibold ${view==='history' ? 'bg-white text-logo-green-700 shadow' : 'text-slate-500'}`}>
                                        <Icon name="history" size={14}/> <span className="hidden sm:inline ml-1">History</span>
                                    </button>

                                    {/* NEW: Live Map tab (map-pin icon) */}
                                    <button onClick={() => setView('live_map')} className={`px-3 py-2 rounded-md text-sm font-semibold ${view==='live_map' ? 'bg-white text-logo-green-700 shadow' : 'text-slate-500'}`}>
                                        <Icon name="map-pin" size={14}/> <span className="hidden sm:inline ml-1">Live Map</span>
                                    </button>

                                    <button onClick={() => setView('team')} className={`px-3 py-2 rounded-md text-sm font-semibold ${view==='team' ? 'bg-white text-logo-green-700 shadow' : 'text-slate-500'}`}>
                                        <Icon name="users" size={14}/> <span className="hidden sm:inline ml-1">Team</span>
                                    </button>
                                    <button onClick={() => setView('lists')} className={`px-3 py-2 rounded-md text-sm font-semibold ${view==='lists' ? 'bg-white text-logo-green-700 shadow' : 'text-slate-500'}`}>
                                        <Icon name="archive" size={14}/> <span className="hidden sm:inline ml-1">Lists</span>
                                    </button>
                                    <button onClick={() => setView('profile')} className={`px-3 py-2 rounded-md text-sm font-semibold ${view==='profile' ? 'bg-white text-logo-green-700 shadow' : 'text-slate-500'}`}>
                                        <Icon name="user" size={14}/> <span className="hidden sm:inline ml-1">Profile</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main content area */}
                    <main className="max-w-6xl mx-auto p-4">
                        { view === 'dashboard' && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-bold text-logo-green-800">Dashboard ‚Äî {dashboardDate}</h2>
                                <p className="text-sm text-slate-500">Your dashboard content lives here (kept from original index).</p>
                                {/* ... original dashboard content remains intact in your real file ... */}
                            </div>
                        )}

                        { view === 'history' && (
                            <div>
                                <h2 className="text-xl font-bold">History</h2>
                                <p className="text-sm text-slate-500">History area (original content)</p>
                            </div>
                        )}

                        { view === 'team' && (
                            <div><h2 className="text-xl font-bold">Team</h2></div>
                        )}

                        { view === 'lists' && (
                            <div><h2 className="text-xl font-bold">Lists / Master Data</h2></div>
                        )}

                        { view === 'profile' && (
                            <div><h2 className="text-xl font-bold">Profile</h2></div>
                        )}

                        {/* IMPORTANT: live_map is rendered as a FULLSCREEN overlay for best UX (Option A) */}
                        { view === 'live_map' && fb && (
                            <LiveMapView fb={fb} onBack={() => setView('dashboard')} />
                        )}

                        {/* While firebase not ready */}
                        { (!fb || !fb.db) && view === 'live_map' && (
                            <div className="p-6 bg-white rounded-xl shadow text-center">
                                <p className="text-slate-500">Connecting to Firebase...</p>
                            </div>
                        )}

                    </main>

                    { isGlobalLoading && <LoadingOverlay message="Processing..." /> }

                </div>
            );
        };

        // Render app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
