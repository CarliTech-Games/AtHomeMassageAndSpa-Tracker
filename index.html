<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6', 100: '#CCFFCC', 500: '#00B300', 
                            600: '#009900', 700: '#008000', 800: '#006600', 900: '#004C00',
                        },
                        'teal': { 600: '#008080' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #008000; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .loader-lg { width: 48px; height: 48px; border-width: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Map Styles */
        #map-container { height: 500px; width: 100%; border-radius: 12px; z-index: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = ['Guadalupe', 'Mabolo', 'Talisay', 'Bacayan', 'Lapu-lapu', 'AS Fortuna'];
        const SERVICE_CATEGORIES = ['Specialized Massage', 'Relax & Revive', 'Premium Massage', 'Add-ons', 'Others'];
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        
        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons({ root: wrapperRef.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className, ...props } });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        // --- HELPERS ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            const msgUint8 = new TextEncoder().encode(pin);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };

        const getMillis = (ts) => {
            if (!ts) return Date.now();
            if (typeof ts === 'number') return ts;
            if (typeof ts.toMillis === 'function') return ts.toMillis();
            if (ts.seconds) return ts.seconds * 1000;
            return 0;
        };

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- COMPONENTS ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );

        // --- MAP COMPONENT ---
        const LiveMap = ({ activeDrivers }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});

            useEffect(() => {
                if (!mapRef.current) return;

                // Initialize Map (Center on Cebu City)
                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current).setView([10.3157, 123.8854], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);
                }

                const map = mapInstanceRef.current;

                // Create custom icon
                const carIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:#008000;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });

                // Update Markers
                activeDrivers.forEach(driver => {
                    if (driver.location && driver.location.lat && driver.location.lng) {
                        const { lat, lng } = driver.location;
                        const lastActive = getMillis(driver.lastUpdated);
                        const isStale = (Date.now() - lastActive) > 300000; // 5 mins

                        if (markersRef.current[driver.id]) {
                            // Move existing marker
                            markersRef.current[driver.id].setLatLng([lat, lng]);
                            markersRef.current[driver.id].setPopupContent(`<b>${driver.name}</b><br><span style="color:${isStale?'red':'green'}">${isStale ? 'Offline?' : 'Active'}</span>`);
                        } else {
                            // Create new marker
                            const marker = L.marker([lat, lng], { icon: carIcon }).addTo(map);
                            marker.bindPopup(`<b>${driver.name}</b><br><span style="color:${isStale?'red':'green'}">${isStale ? 'Offline?' : 'Active'}</span>`);
                            markersRef.current[driver.id] = marker;
                        }
                    }
                });

                // Cleanup removed drivers
                Object.keys(markersRef.current).forEach(id => {
                    if (!activeDrivers.find(d => d.id === id)) {
                        map.removeLayer(markersRef.current[id]);
                        delete markersRef.current[id];
                    }
                });

            }, [activeDrivers]);

            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="map" size={20} className="text-logo-green-700"/> Live Driver Map</h2>
                        <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold animate-pulse">{activeDrivers.length} Active</span>
                    </div>
                    <div id="map-container" ref={mapRef}></div>
                    <div className="mt-2 text-xs text-slate-400 italic text-center">
                        Map updates automatically as drivers move.
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [driversList, setDriversList] = useState([]); // List of names
            const [activeDrivers, setActiveDrivers] = useState([]); // Real-time GPS data
            
            // View State
            const [view, setView] = useState('dashboard');
            const [modal, setModal] = useState({ isOpen: false });
            const [loading, setLoading] = useState(false);

            // Data State
            const [transactions, setTransactions] = useState([]);
            const [offlineQueue, setOfflineQueue] = useState([]);

            // Form State
            const [loginData, setLoginData] = useState({ user: '', pin: '', branch: '' });
            const [formData, setFormData] = useState({
                clientName: '', service: '', amount: '', type: 'booking', 
                location: 'spa', driver: '', paymentMethod: 'Cash', bookingDate: getTodayStr(), time: ''
            });

            // Initialize Firebase
            useEffect(() => {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                auth.signInAnonymously().then(u => setFb({ db, auth }));
                
                // Restore User
                const saved = localStorage.getItem('spa_user');
                if(saved) setUser(JSON.parse(saved));
            }, []);

            // Listeners
            useEffect(() => {
                if (!fb) return;
                
                // Transactions Listener
                const unsubTrans = fb.db.collection('drivers').onSnapshot(snap => {
                    // Placeholder for future logic if needed
                });

                // LIVE DRIVER TRACKING LISTENER
                const unsubLiveDrivers = fb.db.collection('drivers').where('status', '==', 'active')
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setActiveDrivers(data);
                    });

                return () => { unsubLiveDrivers(); };
            }, [fb]);

            // Handle Login
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                // (Simplified Login Logic for brevity - assuming user exists or demo)
                const hashedPassword = await hashPin(loginData.pin);
                // For demo, just log them in if PIN is 4 chars
                if(loginData.pin.length >= 4) {
                    const u = { name: 'Staff User', role: 'admin', currentBranch: loginData.branch };
                    setUser(u);
                    localStorage.setItem('spa_user', JSON.stringify(u));
                }
                setLoading(false);
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                        <form onSubmit={handleLogin} className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                            <h1 className="text-2xl font-bold text-logo-green-700 mb-6 text-center">AHMAS Tracker</h1>
                            <select className="w-full p-3 border rounded mb-3" required onChange={e=>setLoginData({...loginData, branch:e.target.value})}>
                                <option value="">Select Branch</option>
                                {BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}
                            </select>
                            <input className="w-full p-3 border rounded mb-3" placeholder="Username" required onChange={e=>setLoginData({...loginData, user:e.target.value})}/>
                            <input className="w-full p-3 border rounded mb-6" type="password" placeholder="PIN" required onChange={e=>setLoginData({...loginData, pin:e.target.value})}/>
                            <button className="w-full bg-logo-green-700 text-white p-3 rounded font-bold">Login</button>
                        </form>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    {/* Header */}
                    <header className="bg-white p-4 border-b flex justify-between items-center sticky top-0 z-20">
                        <h1 className="font-extrabold text-logo-green-800">AHMAS System</h1>
                        <button onClick={()=>{setUser(null);localStorage.removeItem('spa_user')}} className="text-slate-400"><Icon name="log-out" size={20}/></button>
                    </header>

                    {/* Navigation */}
                    <div className="p-4 sticky top-[60px] z-10 bg-slate-50/90 backdrop-blur">
                        <div className="flex bg-slate-200 p-1 rounded-xl overflow-x-auto">
                            <button onClick={()=>setView('dashboard')} className={`flex-1 py-2 px-4 rounded-lg text-xs font-bold flex items-center gap-1 ${view==='dashboard'?'bg-white shadow text-logo-green-700':'text-slate-500'}`}><Icon name="layout-dashboard" size={14}/> Dashboard</button>
                            <button onClick={()=>setView('map')} className={`flex-1 py-2 px-4 rounded-lg text-xs font-bold flex items-center gap-1 ${view==='map'?'bg-white shadow text-logo-green-700':'text-slate-500'}`}><Icon name="map" size={14}/> Live Map</button>
                            <button onClick={()=>setView('add')} className={`flex-1 py-2 px-4 rounded-lg text-xs font-bold flex items-center gap-1 ${view==='add'?'bg-white shadow text-logo-green-700':'text-slate-500'}`}><Icon name="plus" size={14}/> Booking</button>
                        </div>
                    </div>

                    <main className="p-4 max-w-3xl mx-auto">
                        
                        {/* LIVE MAP VIEW */}
                        {view === 'map' && (
                            <div className="fade-in">
                                <LiveMap activeDrivers={activeDrivers} />
                                <div className="mt-4">
                                    <h3 className="font-bold text-slate-700 mb-2">Active Drivers List</h3>
                                    {activeDrivers.length === 0 ? (
                                        <div className="bg-white p-4 rounded text-center text-slate-400 italic">No drivers online.</div>
                                    ) : (
                                        <div className="space-y-2">
                                            {activeDrivers.map(d => (
                                                <div key={d.id} className="bg-white p-3 rounded shadow-sm border border-slate-100 flex justify-between items-center">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                                        <span className="font-bold">{d.name}</span>
                                                    </div>
                                                    <span className="text-xs text-slate-400">
                                                        Speed: {Math.round(d.speed || 0)} m/s
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* DASHBOARD VIEW (Simplified for this snippet) */}
                        {view === 'dashboard' && (
                            <div className="fade-in text-center py-10">
                                <Icon name="layout-dashboard" size={48} className="mx-auto text-slate-300 mb-4"/>
                                <h2 className="text-xl font-bold text-slate-600">Dashboard Ready</h2>
                                <p className="text-slate-400">Use the tabs above to navigate.</p>
                            </div>
                        )}

                        {/* BOOKING VIEW (Simplified for this snippet) */}
                        {view === 'add' && (
                            <div className="fade-in bg-white p-6 rounded-xl border border-logo-green-100">
                                <h2 className="font-bold mb-4">New Booking</h2>
                                <input className="w-full p-3 border rounded mb-3" placeholder="Client Name"/>
                                <button className="w-full bg-logo-green-700 text-white p-4 rounded font-bold">Save</button>
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
